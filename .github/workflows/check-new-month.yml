name: Check new month data availability

on:
  schedule:
    - cron: "0 0,6,12,18 * * *"
  workflow_dispatch:
  push:
    branches:
      - tmp
jobs:
  check-availability:
    name: Check if previous month data is available
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Download previous state
        uses: actions/download-artifact@v3
        continue-on-error: true
        with:
          name: last-processed-month
          path: .
      
      - name: Calculate previous month
        id: month
        run: |
          PREVIOUS_MONTH=$(date -d "last month" +"%Y-m%m")
          PREVIOUS_MONTH_NAME=$(date -d "last month" +"%B %Y")
          FILE_NAME="deces-${PREVIOUS_MONTH}.txt.gz"
          
          echo "previous_month=${PREVIOUS_MONTH}" >> $GITHUB_OUTPUT
          echo "previous_month_name=${PREVIOUS_MONTH_NAME}" >> $GITHUB_OUTPUT
          echo "file_name=${FILE_NAME}" >> $GITHUB_OUTPUT
          
          echo "ðŸ“… Nous sommes en $(date +'%B %Y')"
          echo "ðŸ” Recherche des donnÃ©es de: ${PREVIOUS_MONTH_NAME}"
      
      - name: Check if already notified
        id: check_notified
        run: |
          if [ -f ".last_processed_month" ]; then
            LAST_NOTIFIED=$(cat ".last_processed_month")
            echo "Dernier mois traitÃ©: ${LAST_NOTIFIED}"
            
            if [ "$LAST_NOTIFIED" = "${{ steps.month.outputs.previous_month }}" ]; then
              echo "already_notified=true" >> $GITHUB_OUTPUT
              echo "âœ… DÃ©jÃ  notifiÃ© pour ${{ steps.month.outputs.previous_month }}"
              exit 0
            fi
          fi
          
          echo "already_notified=false" >> $GITHUB_OUTPUT
          echo "ðŸ”„ Nouveau mois Ã  vÃ©rifier"
      
      - name: Check file on data.gouv.fr
        id: check_file
        if: steps.check_notified.outputs.already_notified != 'true'
        run: |
          FILE_BASE="deces-${{ steps.month.outputs.previous_month }}"
          API_URL="https://www.data.gouv.fr/api/1/datasets/fichier-des-personnes-decedees"
          
          echo "ðŸ” VÃ©rification via API data.gouv.fr..."
          
          RESPONSE=$(curl -sL "$API_URL")
          
          if [ $? -ne 0 ]; then
            echo "âŒ Erreur API"
            echo "available=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if ! echo "$RESPONSE" | jq empty 2>/dev/null; then
            echo "âŒ RÃ©ponse invalide"
            echo "available=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "âœ… API accessible"
          
          URL_TXT=$(echo "$RESPONSE" | jq -r ".resources[] | select(.title == \"${FILE_BASE}.txt\") | .url" 2>/dev/null | head -1)
          URL_GZ=$(echo "$RESPONSE" | jq -r ".resources[] | select(.title == \"${FILE_BASE}.txt.gz\") | .url" 2>/dev/null | head -1)
          
          if [ -n "$URL_TXT" ] && [ "$URL_TXT" != "null" ]; then
            echo "available=true" >> $GITHUB_OUTPUT
            echo "file_url=${URL_TXT}" >> $GITHUB_OUTPUT
            echo "âœ… Fichier trouvÃ©: ${FILE_BASE}.txt"
          elif [ -n "$URL_GZ" ] && [ "$URL_GZ" != "null" ]; then
            echo "available=true" >> $GITHUB_OUTPUT
            echo "file_url=${URL_GZ}" >> $GITHUB_OUTPUT
            echo "âœ… Fichier trouvÃ©: ${FILE_BASE}.txt.gz"
          else
            echo "available=false" >> $GITHUB_OUTPUT
            echo "â³ Pas encore disponible"
          fi
      
      - name: Get file info
        id: file_info
        if: steps.check_file.outputs.available == 'true'
        run: |
          URL="${{ steps.check_file.outputs.file_url }}"
          SIZE=$(curl -sIL "$URL" | grep -i content-length | awk '{print $2}' | tr -d '\r' | tail -1)
          
          if [ -n "$SIZE" ] && [ "$SIZE" -gt 0 ] 2>/dev/null; then
            SIZE_MB=$(echo "scale=2; $SIZE / 1024 / 1024" | bc)
            echo "size=${SIZE_MB} MB" >> $GITHUB_OUTPUT
          else
            echo "size=N/A" >> $GITHUB_OUTPUT
          fi
      
      - name: Save state
        if: steps.check_file.outputs.available == 'true'
        run: |
          echo "${{ steps.month.outputs.previous_month }}" > .last_processed_month
          echo "âœ… Ã‰tat sauvegardÃ©"
      
      - name: Upload state
        if: steps.check_file.outputs.available == 'true'
        uses: actions/upload-artifact@v3
        with:
          name: last-processed-month
          path: .last_processed_month
          retention-days: 90
      
      - name: Send Discord notification
        if: steps.check_file.outputs.available == 'true'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          MONTH="${{ steps.month.outputs.previous_month }}"
          MONTH_NAME="${{ steps.month.outputs.previous_month_name }}"
          FILE="${{ steps.month.outputs.file_name }}"
          URL="${{ steps.check_file.outputs.file_url }}"
          SIZE="${{ steps.file_info.outputs.size }}"
          
          curl -H "Content-Type: application/json" -d '{
            "content": "@here ðŸŽ‰ Nouveau fichier de dÃ©cÃ¨s disponible !",
            "embeds": [{
              "title": "ðŸ“Š Nouvelles donnÃ©es disponibles",
              "description": "Les donnÃ©es de **'"${MONTH_NAME}"'** sont disponibles",
              "color": 3066993,
              "fields": [
                {"name": "ðŸ“… Mois", "value": "'"${MONTH_NAME}"'", "inline": true},
                {"name": "ðŸ“„ Fichier", "value": "`'"${FILE}"'`", "inline": true},
                {"name": "ðŸ’¾ Taille", "value": "'"${SIZE}"'", "inline": true},
                {"name": "ðŸ”— URL", "value": "[TÃ©lÃ©charger]('"${URL}"')", "inline": false},
                {"name": "ðŸš€ Commande", "value": "```bash\n./run-local-ES-update.sh \n```", "inline": false}
              ]
            }]
          }' "$DISCORD_WEBHOOK"
          
          echo "âœ… Notification Discord envoyÃ©e"
