name: Check new month data availability

on:
  schedule:
    - cron: "0 0,6,12,18 * * *"
  workflow_dispatch:
  push:
    branches:
      - features/feature-discord-local-workflow

jobs:
  check-availability:
    name: Check if previous month data is available
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Calculate previous month
        id: month
        run: |
          PREVIOUS_MONTH=$(date -d "last month" +"%Y-m%m")
          PREVIOUS_MONTH_NAME=$(date -d "last month" +"%B %Y")
          FILE_NAME="deces-${PREVIOUS_MONTH}.txt.gz"
          
          echo "previous_month=${PREVIOUS_MONTH}" >> $GITHUB_OUTPUT
          echo "previous_month_name=${PREVIOUS_MONTH_NAME}" >> $GITHUB_OUTPUT
          echo "file_name=${FILE_NAME}" >> $GITHUB_OUTPUT
          
          echo "ðŸ“… Nous sommes en $(date +'%B %Y')"
          echo "ðŸ” Recherche des donnÃ©es de: ${PREVIOUS_MONTH_NAME}"
      
      - name: Check if already notified
        id: check_notified
        run: |
          MARKER_FILE=".github/workflows/.last_processed_month"
          
          if [ -f "$MARKER_FILE" ]; then
            LAST_NOTIFIED=$(cat "$MARKER_FILE")
            if [ "$LAST_NOTIFIED" = "${{ steps.month.outputs.previous_month }}" ]; then
              echo "already_notified=true" >> $GITHUB_OUTPUT
              echo "âœ… DÃ©jÃ  notifiÃ© pour ${{ steps.month.outputs.previous_month }}"
              exit 0
            fi
          fi
          
          echo "already_notified=false" >> $GITHUB_OUTPUT
      
      - name: Check file on data.gouv.fr
        id: check_file
        if: steps.check_notified.outputs.already_notified != 'true'
        run: |
          FILE_BASE="deces-${{ steps.month.outputs.previous_month }}"
          API_URL="https://www.data.gouv.fr/api/1/datasets/fichier-des-personnes-decedees"
          
          echo "ðŸ” VÃ©rification via API data.gouv.fr..."
          echo "   URL: ${API_URL}"
          
          # TÃ©lÃ©charger la rÃ©ponse avec gestion d'erreur
          RESPONSE=$(curl -s -w "\n%{http_code}" "$API_URL")
          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "   HTTP Code: ${HTTP_CODE}"
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ Erreur API (HTTP ${HTTP_CODE})"
            echo "available=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # VÃ©rifier que c'est du JSON valide
          if ! echo "$BODY" | jq empty 2>/dev/null; then
            echo "âŒ RÃ©ponse API invalide (pas du JSON)"
            echo "available=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "âœ… API accessible, recherche du fichier..."
          
          # Chercher .txt
          URL_TXT=$(echo "$BODY" | jq -r ".resources[] | select(.title == \"${FILE_BASE}.txt\") | .url" 2>/dev/null | head -1)
          
          # Chercher .txt.gz
          URL_GZ=$(echo "$BODY" | jq -r ".resources[] | select(.title == \"${FILE_BASE}.txt.gz\") | .url" 2>/dev/null | head -1)
          
          if [ -n "$URL_TXT" ] && [ "$URL_TXT" != "null" ]; then
            echo "available=true" >> $GITHUB_OUTPUT
            echo "file_url=${URL_TXT}" >> $GITHUB_OUTPUT
            echo "file_type=txt" >> $GITHUB_OUTPUT
            echo "âœ… Fichier trouvÃ©: ${FILE_BASE}.txt"
            echo "   URL: ${URL_TXT}"
          elif [ -n "$URL_GZ" ] && [ "$URL_GZ" != "null" ]; then
            echo "available=true" >> $GITHUB_OUTPUT
            echo "file_url=${URL_GZ}" >> $GITHUB_OUTPUT
            echo "file_type=txt.gz" >> $GITHUB_OUTPUT
            echo "âœ… Fichier trouvÃ©: ${FILE_BASE}.txt.gz"
            echo "   URL: ${URL_GZ}"
          else
            echo "available=false" >> $GITHUB_OUTPUT
            echo "â³ Pas encore disponible: ${FILE_BASE}.txt / ${FILE_BASE}.txt.gz"
            
            # Debug: lister les 10 derniers fichiers deces
            echo ""
            echo "ðŸ“‹ Derniers fichiers disponibles:"
            echo "$BODY" | jq -r '.resources[] | select(.title | startswith("deces-")) | .title' 2>/dev/null | sort -r | head -10
          fi
      
      - name: Get file info
        id: file_info
        if: steps.check_file.outputs.available == 'true'
        run: |
          URL="${{ steps.check_file.outputs.file_url }}"
          
          echo "ðŸ“¦ RÃ©cupÃ©ration des informations du fichier..."
          
          # RÃ©cupÃ©rer la taille
          SIZE=$(curl -sI -L "$URL" | grep -i content-length | awk '{print $2}' | tr -d '\r' | head -1)
          
          if [ -n "$SIZE" ] && [ "$SIZE" -gt 0 ] 2>/dev/null; then
            SIZE_MB=$(echo "scale=2; $SIZE / 1024 / 1024" | bc)
            echo "size=${SIZE_MB} MB" >> $GITHUB_OUTPUT
            echo "   Taille: ${SIZE_MB} MB"
          else
            echo "size=N/A" >> $GITHUB_OUTPUT
            echo "   Taille: Non disponible"
          fi
      
      - name: Mark as notified
        if: steps.check_file.outputs.available == 'true'
        run: |
          mkdir -p .github/workflows
          echo "${{ steps.month.outputs.previous_month }}" > .github/workflows/.last_processed_month
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/workflows/.last_processed_month
          git commit -m "ðŸ“Š Nouveau mois dÃ©tectÃ©: ${{ steps.month.outputs.previous_month }}"
          git push
      
      - name: Send Discord notification
        if: steps.check_file.outputs.available == 'true'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          MONTH="${{ steps.month.outputs.previous_month }}"
          MONTH_NAME="${{ steps.month.outputs.previous_month_name }}"
          FILE="${{ steps.month.outputs.file_name }}"
          URL="${{ steps.check_file.outputs.file_url }}"
          SIZE="${{ steps.file_info.outputs.size }}"
          CURRENT=$(date +'%B %Y')
          
          PAYLOAD=$(cat <<EOF
          {
            "content": "@here ðŸŽ‰ Nouveau fichier de dÃ©cÃ¨s disponible !",
            "embeds": [{
              "title": "ðŸ“Š Nouvelles donnÃ©es disponibles",
              "description": "Les donnÃ©es de **${MONTH_NAME}** sont disponibles sur data.gouv.fr (nous sommes en ${CURRENT})",
              "color": 3066993,
              "fields": [
                {
                  "name": "ðŸ“… Mois des donnÃ©es",
                  "value": "${MONTH_NAME}",
                  "inline": true
                },
                {
                  "name": "ðŸ“„ Fichier",
                  "value": "\`${FILE}\`",
                  "inline": true
                },
                {
                  "name": "ðŸ’¾ Taille",
                  "value": "${SIZE}",
                  "inline": true
                },
                {
                  "name": "ðŸ”— URL de tÃ©lÃ©chargement",
                  "value": "[Cliquez ici](${URL})",
                  "inline": false
                },
                {
                  "name": "ðŸš€ Commande Ã  exÃ©cuter",
                  "value": "\`\`\`bash\ncd /home/sebastien-fournier/Documents/VSCode/matchID-multirepo/deces-dataprep\n./run-local-update.sh ${MONTH}\n\`\`\`",
                  "inline": false
                },
                {
                  "name": "â° DÃ©tectÃ© le",
                  "value": "$(date +'%d/%m/%Y Ã  %H:%M:%S UTC')",
                  "inline": false
                }
              ],
              "footer": {
                "text": "deces-dataprep â€¢ DÃ©tection automatique"
              },
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"
            }]
          }
          EOF
          )
          
          if curl -H "Content-Type: application/json" -d "$PAYLOAD" "$DISCORD_WEBHOOK"; then
            echo "âœ… Notification Discord envoyÃ©e"
          else
            echo "âš ï¸ Ã‰chec de l'envoi Discord"
          fi
