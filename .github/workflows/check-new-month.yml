name: Check new month data availability

on:
  schedule:
    - cron: "0 0,6,12,18 * * *"
  workflow_dispatch:
  push:
    branches:
      - features/feature-discord-local-workflow

jobs:
  check-availability:
    name: Check if previous month data is available
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Calculate previous month
        id: month
        run: |
          PREVIOUS_MONTH=$(date -d "last month" +"%Y-m%m")
          PREVIOUS_MONTH_NAME=$(date -d "last month" +"%B %Y")
          FILE_NAME="deces-${PREVIOUS_MONTH}.txt.gz"
          
          echo "previous_month=${PREVIOUS_MONTH}" >> $GITHUB_OUTPUT
          echo "previous_month_name=${PREVIOUS_MONTH_NAME}" >> $GITHUB_OUTPUT
          echo "file_name=${FILE_NAME}" >> $GITHUB_OUTPUT
          
          echo "ðŸ“… Nous sommes en $(date +'%B %Y')"
          echo "ðŸ” Recherche des donnÃ©es de: ${PREVIOUS_MONTH_NAME}"
      
      - name: Check if already notified
        id: check_notified
        run: |
          MARKER_FILE=".github/workflows/.last_processed_month"
          
          if [ -f "$MARKER_FILE" ]; then
            LAST_NOTIFIED=$(cat "$MARKER_FILE")
            if [ "$LAST_NOTIFIED" = "${{ steps.month.outputs.previous_month }}" ]; then
              echo "already_notified=true" >> $GITHUB_OUTPUT
              echo "âœ… DÃ©jÃ  notifiÃ© pour ${{ steps.month.outputs.previous_month }}"
              exit 0
            fi
          fi
          
          echo "already_notified=false" >> $GITHUB_OUTPUT
      
      - name: Check file on data.gouv.fr
        id: check_file
        if: steps.check_notified.outputs.already_notified != 'true'
        run: |
          FILE_BASE="deces-${{ steps.month.outputs.previous_month }}"
          API_URL="https://www.data.gouv.fr/api/1/datasets/fichier-des-personnes-decedees"
          
          echo "ðŸ” VÃ©rification via API data.gouv.fr..."
          RESPONSE=$(curl -s "$API_URL")
          
          # Chercher .txt
          URL_TXT=$(echo "$RESPONSE" | jq -r ".resources[] | select(.title == \"${FILE_BASE}.txt\") | .url" | head -1)
          
          # Chercher .txt.gz
          URL_GZ=$(echo "$RESPONSE" | jq -r ".resources[] | select(.title == \"${FILE_BASE}.txt.gz\") | .url" | head -1)
          
          if [ -n "$URL_TXT" ] && [ "$URL_TXT" != "null" ]; then
            echo "available=true" >> $GITHUB_OUTPUT
            echo "file_url=${URL_TXT}" >> $GITHUB_OUTPUT
            echo "file_type=txt" >> $GITHUB_OUTPUT
            echo "âœ… Fichier trouvÃ©: ${FILE_BASE}.txt"
          elif [ -n "$URL_GZ" ] && [ "$URL_GZ" != "null" ]; then
            echo "available=true" >> $GITHUB_OUTPUT
            echo "file_url=${URL_GZ}" >> $GITHUB_OUTPUT
            echo "file_type=txt.gz" >> $GITHUB_OUTPUT
            echo "âœ… Fichier trouvÃ©: ${FILE_BASE}.txt.gz"
          else
            echo "available=false" >> $GITHUB_OUTPUT
            echo "â³ Pas encore disponible"
          fi
      
      - name: Get file info
        id: file_info
        if: steps.check_file.outputs.available == 'true'
        run: |
          URL="${{ steps.check_file.outputs.file_url }}"
          
          # RÃ©cupÃ©rer la taille
          SIZE=$(curl -sI "$URL" | grep -i content-length | awk '{print $2}' | tr -d '\r')
          if [ -n "$SIZE" ]; then
            SIZE_MB=$(echo "scale=2; $SIZE / 1024 / 1024" | bc)
            echo "size=${SIZE_MB} MB" >> $GITHUB_OUTPUT
          else
            echo "size=N/A" >> $GITHUB_OUTPUT
          fi
      
      - name: Mark as notified
        if: steps.check_file.outputs.available == 'true'
        run: |
          mkdir -p .github/workflows
          echo "${{ steps.month.outputs.previous_month }}" > .github/workflows/.last_processed_month
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/workflows/.last_processed_month
          git commit -m "ðŸ“Š Nouveau mois dÃ©tectÃ©: ${{ steps.month.outputs.previous_month }}"
          git push
      
      - name: Send Discord notification
        if: steps.check_file.outputs.available == 'true'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          MONTH="${{ steps.month.outputs.previous_month }}"
          MONTH_NAME="${{ steps.month.outputs.previous_month_name }}"
          FILE="${{ steps.month.outputs.file_name }}"
          URL="${{ steps.check_file.outputs.file_url }}"
          SIZE="${{ steps.file_info.outputs.size }}"
          CURRENT=$(date +'%B %Y')
          
          PAYLOAD=$(cat <<EOF
          {
            "content": "@here ðŸŽ‰ Nouveau fichier de dÃ©cÃ¨s disponible !",
            "embeds": [{
              "title": "ðŸ“Š Nouvelles donnÃ©es disponibles",
              "description": "Les donnÃ©es de **${MONTH_NAME}** sont disponibles sur data.gouv.fr",
              "color": 3066993,
              "fields": [
                {
                  "name": "ðŸ“… Mois",
                  "value": "${MONTH_NAME}",
                  "inline": true
                },
                {
                  "name": "ðŸ“„ Fichier",
                  "value": "\`${FILE}\`",
                  "inline": true
                },
                {
                  "name": "ðŸ’¾ Taille",
                  "value": "${SIZE}",
                  "inline": true
                },
                {
                  "name": "ðŸ”— URL",
                  "value": "[TÃ©lÃ©charger](${URL})",
                  "inline": false
                },
                {
                  "name": "ðŸš€ Commande",
                  "value": "\`\`\`bash\ncd /home/sebastien-fournier/Documents/VSCode/matchID-multirepo/deces-dataprep\n./run-local-update.sh ${MONTH}\n\`\`\`",
                  "inline": false
                }
              ],
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"
            }]
          }
          EOF
          )
          
          curl -H "Content-Type: application/json" -d "$PAYLOAD" "$DISCORD_WEBHOOK"
          echo "âœ… Notification envoyÃ©e"
