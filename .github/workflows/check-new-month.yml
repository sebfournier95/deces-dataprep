name: Check new month data availability

on:
  schedule:
    - cron: "0 0,6,12,18 * * *"
  workflow_dispatch:
  push:
    branches:
      - master

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  check-availability:
    name: Check if previous month data is available
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Restore previous state from cache
        uses: actions/cache/restore@v4
        id: cache-restore
        with:
          path: .last_processed_month
          key: last-processed-month-${{ steps.month.outputs.previous_month }}
      
      - name: Calculate previous month
        id: month
        run: |
          PREVIOUS_MONTH=$(date -d "last month" +"%Y-m%m")
          PREVIOUS_MONTH_NAME=$(date -d "last month" +"%B %Y")
          FILE_NAME="deces-${PREVIOUS_MONTH}.txt.gz"
          
          echo "previous_month=${PREVIOUS_MONTH}" >> $GITHUB_OUTPUT
          echo "previous_month_name=${PREVIOUS_MONTH_NAME}" >> $GITHUB_OUTPUT
          echo "file_name=${FILE_NAME}" >> $GITHUB_OUTPUT
          
          echo "üìÖ Nous sommes en $(date +'%B %Y')"
          echo "üîç Recherche des donn√©es de: ${PREVIOUS_MONTH_NAME}"
      
      - name: Check if already notified
        id: check_notified
        run: |
          echo "DEBUG: cache-hit = ${{ steps.cache-restore.outputs.cache-hit }}"
          echo "DEBUG: previous_month = ${{ steps.month.outputs.previous_month }}"

          ALREADY_NOTIFIED_FLAG="false"

          if [ "${{ steps.cache-restore.outputs.cache-hit }}" = "true" ]; then
            ALREADY_NOTIFIED_FLAG="true"
            echo "‚úÖ Cache hit: D√©j√† notifi√© pour ${{ steps.month.outputs.previous_month }}"
          else
            # Fallback if cache was not hit, but file might exist from a previous run (e.g., if cache was evicted or not saved)
            if [ -f ".last_processed_month" ]; then
              LAST_NOTIFIED=$(cat ".last_processed_month")
              echo "DEBUG: LAST_NOTIFIED (from file) = ${LAST_NOTIFIED}"
              echo "Dernier mois trait√© (fichier local): ${LAST_NOTIFIED}"

              if [ "$LAST_NOTIFIED" = "${{ steps.month.outputs.previous_month }}" ]; then
                ALREADY_NOTIFIED_FLAG="true"
                echo "‚úÖ Fichier local: D√©j√† notifi√© pour ${{ steps.month.outputs.previous_month }}"
              fi
            fi
          fi

          echo "already_notified=${ALREADY_NOTIFIED_FLAG}" >> $GITHUB_OUTPUT
          if [ "$ALREADY_NOTIFIED_FLAG" = "true" ]; then
            echo "‚úÖ D√©j√† notifi√© pour ${{ steps.month.outputs.previous_month }}"
          else
            echo "üîÑ Nouveau mois √† v√©rifier"
          fi
      
      - name: Check file on data.gouv.fr
        id: check_file
        if: steps.check_notified.outputs.already_notified != 'true'
        run: |
          FILE_BASE="deces-${{ steps.month.outputs.previous_month }}"
          API_URL="https://www.data.gouv.fr/api/1/datasets/fichier-des-personnes-decedees"
          
          echo "üîç V√©rification via API data.gouv.fr..."
          
          RESPONSE=$(curl -sL "$API_URL")
          
          if [ $? -ne 0 ]; then
            echo "‚ùå Erreur API"
            echo "available=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if ! echo "$RESPONSE" | jq empty 2>/dev/null; then
            echo "‚ùå R√©ponse invalide"
            echo "available=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "‚úÖ API accessible"
          
          URL_TXT=$(echo "$RESPONSE" | jq -r ".resources[] | select(.title == \"${FILE_BASE}.txt\") | .url" 2>/dev/null | head -1)
          URL_GZ=$(echo "$RESPONSE" | jq -r ".resources[] | select(.title == \"${FILE_BASE}.txt.gz\") | .url" 2>/dev/null | head -1)
          
          if [ -n "$URL_TXT" ] && [ "$URL_TXT" != "null" ]; then
            echo "available=true" >> $GITHUB_OUTPUT
            echo "file_url=${URL_TXT}" >> $GITHUB_OUTPUT
            echo "‚úÖ Fichier trouv√©: ${FILE_BASE}.txt"
          elif [ -n "$URL_GZ" ] && [ "$URL_GZ" != "null" ]; then
            echo "available=true" >> $GITHUB_OUTPUT
            echo "file_url=${URL_GZ}" >> $GITHUB_OUTPUT
            echo "‚úÖ Fichier trouv√©: ${FILE_BASE}.txt.gz"
          else
            echo "available=false" >> $GITHUB_OUTPUT
            echo "‚è≥ Pas encore disponible"
            
            echo ""
            echo "üìã Derniers fichiers disponibles:"
            echo "$RESPONSE" | jq -r '.resources[] | select(.title | startswith("deces-")) | .title' 2>/dev/null | sort -r | head -10
          fi
      
      - name: Get file info
        id: file_info
        if: steps.check_file.outputs.available == 'true'
        run: |
          URL="${{ steps.check_file.outputs.file_url }}"
          SIZE=$(curl -sIL "$URL" | grep -i content-length | awk '{print $2}' | tr -d '\r' | tail -1)
          
          if [ -n "$SIZE" ] && [ "$SIZE" -gt 0 ] 2>/dev/null; then
            SIZE_MB=$(echo "scale=2; $SIZE / 1024 / 1024" | bc)
            echo "size=${SIZE_MB} MB" >> $GITHUB_OUTPUT
            echo "üì¶ Taille: ${SIZE_MB} MB"
          else
            echo "size=N/A" >> $GITHUB_OUTPUT
          fi
      
      
      - name: Save state to cache
        if: steps.check_file.outputs.available == 'true' && steps.cache-restore.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: .last_processed_month
          key: last-processed-month-${{ steps.month.outputs.previous_month }}
      
      - name: Send Discord notification
        if: steps.check_file.outputs.available == 'true' && steps.check_notified.outputs.already_notified != 'true'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          MONTH="${{ steps.month.outputs.previous_month }}"
          MONTH_NAME="${{ steps.month.outputs.previous_month_name }}"
          FILE="${{ steps.month.outputs.file_name }}"
          URL="${{ steps.check_file.outputs.file_url }}"
          SIZE="${{ steps.file_info.outputs.size }}"
          CURRENT=$(date +'%B %Y')
          
          curl -H "Content-Type: application/json" -d '{
            "content": "üéâ Nouveau fichier de d√©c√®s disponible !",
            "embeds": [{
              "title": "üìä Nouvelles donn√©es disponibles",
              "description": "Les donn√©es de **'"${MONTH_NAME}"'** sont disponibles sur data.gouv.fr (nous sommes en '"${CURRENT}"')",
              "color": 3066993,
              "fields": [
                {"name": "üìÖ Mois des donn√©es", "value": "'"${MONTH_NAME}"'", "inline": true},
                {"name": "üìÑ Fichier", "value": "`'"${FILE}"'`", "inline": true},
                {"name": "üíæ Taille", "value": "'"${SIZE}"'", "inline": true},
                {"name": "‚è∞ D√©tect√© le", "value": "'"$(date +'%d/%m/%Y √† %H:%M:%S UTC')"'", "inline": true},
                {"name": "üîó URL de t√©l√©chargement", "value": "[Cliquez ici]('"${URL}"')", "inline": false},
                {"name": "üöÄ Commande √† ex√©cuter", "value": "```bash\nsudo ./run-local-ES-update.sh \n```", "inline": false}
              ],
              "footer": {
                "text": "deces-dataprep ‚Ä¢ D√©tection automatique"
              },
              "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"'"
            }]
          }' "$DISCORD_WEBHOOK"
          
          echo "‚úÖ Notification Discord envoy√©e"
