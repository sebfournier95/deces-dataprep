name: Check new month data availability

on:
  schedule:
    - cron: "0 0,6,12,18 * * *"
  workflow_dispatch:
  push:
    branches:
      - features/feature-discord-local-workflow

jobs:
  check-availability:
    name: Check if previous month data is available
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Calculate previous month
        id: month
        run: |
          # Calculer le mois prÃ©cÃ©dent
          PREVIOUS_MONTH=$(date -d "last month" +"%Y-m%m")
          PREVIOUS_MONTH_NAME=$(date -d "last month" +"%B %Y")
          FILE_NAME="deces-${PREVIOUS_MONTH}.txt.gz"
          
          echo "previous_month=${PREVIOUS_MONTH}" >> $GITHUB_OUTPUT
          echo "previous_month_name=${PREVIOUS_MONTH_NAME}" >> $GITHUB_OUTPUT
          echo "file_name=${FILE_NAME}" >> $GITHUB_OUTPUT
          
          echo "ðŸ“… Nous sommes en $(date +'%B %Y')"
          echo "ðŸ” Recherche des donnÃ©es de: ${PREVIOUS_MONTH_NAME}"
          echo "ðŸ“„ Fichier recherchÃ©: ${FILE_NAME}"
      
      - name: Check if already processed this month
        id: check_processed
        run: |
          MARKER_FILE=".github/workflows/.last_processed_month"
          
          if [ -f "$MARKER_FILE" ]; then
            LAST_PROCESSED=$(cat "$MARKER_FILE")
            echo "last_processed=${LAST_PROCESSED}" >> $GITHUB_OUTPUT
            
            if [ "$LAST_PROCESSED" = "${{ steps.month.outputs.previous_month }}" ]; then
              echo "already_processed=true" >> $GITHUB_OUTPUT
              echo "âœ… Mois ${{ steps.month.outputs.previous_month }} dÃ©jÃ  traitÃ©"
            else
              echo "already_processed=false" >> $GITHUB_OUTPUT
              echo "ðŸ”„ Nouveau mois dÃ©tectÃ©: ${{ steps.month.outputs.previous_month }}"
            fi
          else
            echo "already_processed=false" >> $GITHUB_OUTPUT
            echo "ðŸ†• Premier run, aucun mois traitÃ© prÃ©cÃ©demment"
          fi
      
      - name: Configure project
        if: steps.check_processed.outputs.already_processed != 'true'
        run: |
          echo "âš™ï¸  Configuration du projet..."
          make config
        env:
          GIT_ROOT: https://github.com/sebfournier95
          DATAGOUV_CONNECTOR: upload
      
      - name: Check file availability and download
        id: check_file
        if: steps.check_processed.outputs.already_processed != 'true'
        run: |
          FILE_NAME="${{ steps.month.outputs.file_name }}"
          
          echo "ðŸ” Tentative de tÃ©lÃ©chargement de ${FILE_NAME}..."
          
          # Utiliser make datagouv-to-upload pour tÃ©lÃ©charger le fichier
          if make datagouv-to-upload FILES_TO_PROCESS="${FILE_NAME}"; then
            # VÃ©rifier si le fichier a Ã©tÃ© tÃ©lÃ©chargÃ©
            UPLOAD_DIR="backend/upload"
            
            if [ -f "${UPLOAD_DIR}/${FILE_NAME}" ]; then
              echo "file_available=true" >> $GITHUB_OUTPUT
              echo "âœ… Fichier tÃ©lÃ©chargÃ© avec succÃ¨s: ${FILE_NAME}"
              
              # Compter les lignes
              LINE_COUNT=$(zcat "${UPLOAD_DIR}/${FILE_NAME}" | wc -l)
              FILE_SIZE=$(du -h "${UPLOAD_DIR}/${FILE_NAME}" | awk '{print $1}')
              
              echo "line_count=${LINE_COUNT}" >> $GITHUB_OUTPUT
              echo "file_size=${FILE_SIZE}" >> $GITHUB_OUTPUT
              
              echo "ðŸ“Š Statistiques:"
              echo "   Lignes: ${LINE_COUNT}"
              echo "   Taille: ${FILE_SIZE}"
            else
              echo "file_available=false" >> $GITHUB_OUTPUT
              echo "â³ Fichier pas encore disponible: ${FILE_NAME}"
              
              # Lister les fichiers tÃ©lÃ©chargÃ©s pour debug
              echo ""
              echo "ðŸ“‹ Fichiers dans ${UPLOAD_DIR}:"
              ls -lh "${UPLOAD_DIR}/" 2>/dev/null | grep "deces-" || echo "Aucun fichier deces trouvÃ©"
            fi
          else
            echo "file_available=false" >> $GITHUB_OUTPUT
            echo "âŒ Ã‰chec du tÃ©lÃ©chargement via make datagouv-to-upload"
          fi
        env:
          DATAGOUV_CONNECTOR: upload
      
      - name: Mark month as processed
        if: steps.check_file.outputs.file_available == 'true'
        run: |
          mkdir -p .github/workflows
          echo "${{ steps.month.outputs.previous_month }}" > .github/workflows/.last_processed_month
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/workflows/.last_processed_month
          git commit -m "ðŸ“Š Nouveau mois traitÃ©: ${{ steps.month.outputs.previous_month }}"
          git push
      
      - name: Send Discord notification
        if: steps.check_file.outputs.file_available == 'true'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          FILE_NAME="${{ steps.month.outputs.file_name }}"
          LINE_COUNT="${{ steps.check_file.outputs.line_count }}"
          FILE_SIZE="${{ steps.check_file.outputs.file_size }}"
          PREVIOUS_MONTH="${{ steps.month.outputs.previous_month }}"
          PREVIOUS_MONTH_NAME="${{ steps.month.outputs.previous_month_name }}"
          CURRENT_MONTH=$(date +'%B %Y')
          
          # Formater le nombre avec des espaces
          LINE_COUNT_FORMATTED=$(printf '%s' ${LINE_COUNT} | sed ':a;s/\B[0-9]\{3\}\>/\ &/;ta')
          
          # Construire le payload JSON pour Discord
          PAYLOAD=$(cat <<EOF
          {
            "content": "@here Nouveau fichier de dÃ©cÃ¨s disponible !",
            "embeds": [{
              "title": "ðŸŽ‰ Nouvelles donnÃ©es disponibles",
              "description": "Les donnÃ©es de **${PREVIOUS_MONTH_NAME}** sont maintenant disponibles (nous sommes en ${CURRENT_MONTH}).",
              "color": 3066993,
              "fields": [
                {
                  "name": "ðŸ“… Mois des donnÃ©es",
                  "value": "${PREVIOUS_MONTH_NAME}",
                  "inline": true
                },
                {
                  "name": "ðŸ“„ Fichier",
                  "value": "\`${FILE_NAME}\`",
                  "inline": true
                },
                {
                  "name": "ðŸ“Š Nombre de dÃ©cÃ¨s",
                  "value": "${LINE_COUNT_FORMATTED}",
                  "inline": true
                },
                {
                  "name": "ðŸ’¾ Taille",
                  "value": "${FILE_SIZE}",
                  "inline": true
                },
                {
                  "name": "â° DÃ©tectÃ© le",
                  "value": "$(date +'%d/%m/%Y Ã  %H:%M:%S UTC')",
                  "inline": true
                },
                {
                  "name": "ðŸ“¦ Bucket",
                  "value": "data.gouv.fr",
                  "inline": true
                },
                {
                  "name": "ðŸš€ Commande Ã  exÃ©cuter",
                  "value": "\`\`\`bash\n./run-local-update.sh ${PREVIOUS_MONTH}\n\`\`\`",
                  "inline": false
                }
              ],
              "footer": {
                "text": "deces-dataprep â€¢ DÃ©tection automatique"
              },
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"
            }]
          }
          EOF
          )
          
          # Envoyer Ã  Discord
          if curl -H "Content-Type: application/json" -d "$PAYLOAD" "$DISCORD_WEBHOOK"; then
            echo "âœ… Notification Discord envoyÃ©e"
          else
            echo "âš ï¸ Ã‰chec de l'envoi de la notification Discord"
          fi
